<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eclipse OS | v21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        * { cursor: none !important; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #000; color: #fff; overflow: hidden; height: 100vh; }
        
        #custom-cursor { position: fixed; width: 20px; height: 20px; border: 2px solid #fff; border-radius: 50%; pointer-events: none; z-index: 10000; transform: translate(-50%, -50%); mix-blend-mode: difference; transition: width 0.3s, height 0.3s; }
        .cursor-dot { position: absolute; width: 4px; height: 4px; background: #fff; border-radius: 50%; }

        .os-window { background: rgba(5,5,5,0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; overflow: hidden; transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); }
        .glass-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .glass-btn:hover { background: #fff; color: #000; }

        #login-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; transition: 1s; }
        
        .stat-bar { height: 4px; border-radius: 2px; background: rgba(255,255,255,0.1); overflow: hidden; }
        .stat-fill { height: 100%; background: #fff; width: 0%; transition: width 1s; }

        #bg-canvas { position: fixed; inset: 0; z-index: 0; }
        .glitch:hover { animation: glitch-anim 0.2s infinite; }
        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        #chat-ui { display: none; }
        .sidebar { width: 300px; transform: translateX(-100%); transition: 0.5s cubic-bezier(0.19, 1, 0.22, 1); }
        .sidebar.open { transform: translateX(0); }
    </style>
</head>
<body>

    <div id="custom-cursor"><div class="cursor-dot"></div></div>
    <canvas id="bg-canvas"></canvas>

    <section id="login-screen">
        <div class="os-window p-10 w-full max-w-md text-center">
            <h2 class="text-4xl font-black mb-2 tracking-tighter">ECLIPSE OS</h2>
            <p class="text-[10px] text-gray-500 uppercase tracking-[0.4em] mb-8">Access Verification</p>
            <div class="space-y-4">
                <input id="auth-email" type="email" placeholder="Terminal ID (Email)" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-white/40 mono text-xs">
                <input id="auth-pass" type="password" placeholder="Passkey" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-white/40 mono text-xs">
                <button onclick="handleLogin()" class="w-full bg-white text-black py-4 font-black text-xs uppercase rounded-xl hover:scale-105 transition">Initialize Session</button>
                <button onclick="handleSignup()" class="text-[9px] text-gray-600 font-bold uppercase tracking-widest hover:text-white transition">Request New Access</button>
            </div>
        </div>
    </section>

    <main id="main-content" class="relative z-10 h-screen w-screen flex flex-col hidden">
        
        <nav class="h-14 border-b border-white/5 bg-black/50 backdrop-blur-xl flex justify-between items-center px-6">
            <div class="flex items-center gap-4">
                <span class="font-black italic tracking-tighter text-xl">ECLIPSE</span>
                <div class="h-4 w-[1px] bg-white/10"></div>
                <span id="os-clock" class="mono text-[10px] text-gray-500">00:00:00</span>
            </div>
            <div class="flex gap-6 items-center">
                <div class="flex flex-col items-end">
                    <span class="text-[8px] font-black text-gray-600 uppercase">Sys Load</span>
                    <div class="w-24 stat-bar mt-1"><div id="load-fill" class="stat-fill"></div></div>
                </div>
                <button onclick="logout()" class="text-[9px] font-black text-red-500 hover:text-white transition">LOGOUT</button>
            </div>
        </nav>

        <div class="flex flex-1 overflow-hidden">
            <aside id="sidebar" class="sidebar bg-black/80 border-r border-white/5 p-6 flex flex-col">
                <button onclick="newChat()" class="glass-btn w-full py-4 rounded-xl font-black text-[10px] uppercase mb-8">+ Nova Sessão</button>
                <div id="chat-list" class="flex-1 space-y-2 overflow-y-auto"></div>
            </aside>

            <section class="flex-1 flex flex-col relative">
                <div id="landing" class="absolute inset-0 z-20 flex flex-col items-center justify-center p-10">
                    <h1 class="text-[10rem] font-black tracking-tighter glitch select-none">ECLIPSE</h1>
                    <div class="grid grid-cols-3 gap-6 w-full max-w-4xl mt-10">
                        <div class="os-window p-6 text-center">
                            <span class="text-[8px] font-black text-gray-600 block mb-2 uppercase">Core Status</span>
                            <span class="text-green-500 font-black text-sm">OPTIMIZED</span>
                        </div>
                        <div class="os-window p-6 text-center">
                            <span class="text-[8px] font-black text-gray-600 block mb-2 uppercase">Neural Link</span>
                            <span class="text-white font-black text-sm">ESTABLISHED</span>
                        </div>
                        <div class="os-window p-6 text-center">
                            <span class="text-[8px] font-black text-gray-600 block mb-2 uppercase">Safety Protocol</span>
                            <span class="text-red-500 font-black text-sm">BYPASSED</span>
                        </div>
                    </div>
                    <button onclick="openChat()" class="mt-12 bg-white text-black px-16 py-6 rounded-full font-black text-xs uppercase tracking-[0.5em] hover:scale-110 transition shadow-2xl">Acessar Terminal</button>
                </div>

                <div id="chat-ui" class="flex-1 flex flex-col">
                    <div id="chat-flow" class="flex-1 overflow-y-auto p-10 space-y-12"></div>
                    <div class="p-10">
                        <div class="max-w-4xl mx-auto flex gap-4 glass-btn p-3 rounded-2xl shadow-2xl focus-within:border-white/40">
                            <button onclick="toggleSidebar()" class="px-4 text-[10px] font-black opacity-50 hover:opacity-100 uppercase">Sessões</button>
                            <input id="user-input" type="text" placeholder="Executar comando..." class="flex-1 bg-transparent py-4 px-2 outline-none text-sm mono">
                            <button onclick="handleSend()" class="bg-white text-black px-10 py-4 rounded-xl font-black text-[10px] uppercase">Enviar</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // CONFIGURAÇÃO FIREBASE (Lendo das Variáveis de Ambiente)
        const firebaseConfig = {
            apiKey: "AIzaSyAsP3iDayVoX9LivuqBWMXpMbsidn5Fd-0",
            authDomain: "fkaa-2e852.firebaseapp.com",
            projectId: "fkaa-2e852",
            storageBucket: "fkaa-2e852.firebasestorage.app",
            messagingSenderId: "258882319543",
            appId: "1:258882319543:web:d665c1adbc4a1479afc932"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // CURSOR TRACKER
        const cursor = document.getElementById('custom-cursor');
        window.onmousemove = (e) => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
            if(e.target.closest('button, input, .os-window')) {
                cursor.style.width = '60px'; cursor.style.height = '60px';
            } else {
                cursor.style.width = '20px'; cursor.style.height = '20px';
            }
        };

        // RELÓGIO E STATUS
        setInterval(() => {
            document.getElementById('os-clock').innerText = new Date().toLocaleTimeString('pt-BR');
            document.getElementById('load-fill').style.width = Math.random() * 100 + '%';
        }, 1000);

        // LOGIN / AUTH
        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
                initOS();
            } catch(e) { alert("Acesso Negado: Credenciais Inválidas."); }
        }

        async function handleSignup() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try {
                await auth.createUserWithEmailAndPassword(email, pass);
                alert("Novo acesso criado. Bem-vindo ao Eclipse.");
                initOS();
            } catch(e) { alert(e.message); }
        }

        function initOS() {
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden');
                initBg();
            }, 1000);
        }

        function logout() { auth.signOut(); location.reload(); }

        // CANVAS BACKGROUND (PARTÍCULAS)
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let pts = [];
        function initBg() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            pts = [];
            for(let i=0; i<100; i++) pts.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5, size: Math.random()*2 });
            animate();
        }
        function animate() {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "rgba(255,255,255,0.1)";
            pts.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if(p.x<0 || p.x>canvas.width) p.vx*=-1; if(p.y<0 || p.y>canvas.height) p.vy*=-1;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(animate);
        }

        // CHAT ENGINE
        let chats = JSON.parse(localStorage.getItem('eclipse_v21')) || [];
        let currentId = null;

        function openChat() {
            document.getElementById('landing').style.display = 'none';
            document.getElementById('chat-ui').style.display = 'flex';
            if(chats.length > 0) switchChat(chats[0].id); else newChat();
        }

        function newChat() {
            const id = Date.now();
            const hour = new Date().getHours();
            const msg = hour < 12 ? "Bom dia" : hour < 18 ? "Boa tarde" : "Boa noite";
            chats.unshift({ id, title: "Sessão Alpha", messages: [{ role: 'model', parts: [{ text: `${msg}, Administrador. Terminal pronto para instruções.` }] }] });
            currentId = id; save(); renderList(); renderMsgs();
        }

        async function handleSend() {
            const input = document.getElementById('user-input');
            const val = input.value.trim();
            if(!val) return;
            const active = chats.find(c => c.id === currentId);
            if(active.messages.length <= 1) active.title = val.substring(0, 15).toUpperCase();
            active.messages.push({ role: 'user', parts: [{ text: val }] });
            input.value = ''; renderMsgs();
            const load = createLoader();
            try {
                const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messages: active.messages}) });
                const data = await res.json();
                load.remove();
                active.messages.push({ role: 'model', parts: [{ text: data.reply }] });
                save(); renderMsgs(); renderList();
            } catch(e) { load.innerText = "CRITICAL ERROR: API OFFLINE"; }
        }

        function renderMsgs() {
            const flow = document.getElementById('chat-flow'); flow.innerHTML = '';
            const active = chats.find(c => c.id === currentId);
            active.messages.forEach(m => {
                const isB = m.role === 'model';
                const div = document.createElement('div');
                div.className = `flex flex-col ${isB ? 'items-start' : 'items-end'}`;
                div.innerHTML = `
                    <div class="max-w-[80%] ${isB ? 'os-window p-6' : 'bg-white text-black p-4 rounded-2xl'}">
                        <span class="text-[8px] font-black uppercase mb-2 block opacity-50">${isB ? 'Eclipse OS' : 'Admin'}</span>
                        <div class="text-sm leading-relaxed">${isB ? marked.parse(m.parts[0].text) : m.parts[0].text}</div>
                    </div>`;
                flow.appendChild(div);
            });
            flow.scrollTop = flow.scrollHeight;
            hljs.highlightAll();
        }

        function renderList() {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            chats.forEach(c => {
                const d = document.createElement('div');
                d.className = `p-4 rounded-xl cursor-none transition ${c.id === currentId ? 'bg-white text-black font-black' : 'hover:bg-white/5 text-gray-500'}`;
                d.onclick = () => switchChat(c.id);
                d.innerHTML = `<div class="flex justify-between items-center text-[10px]"><span>${c.title}</span><span onclick="event.stopPropagation(); deleteChat(${c.id})">×</span></div>`;
                list.appendChild(d);
            });
        }

        function createLoader() {
            const d = document.createElement('div'); d.className = 'text-center p-10 mono text-[10px] animate-pulse opacity-50'; d.innerText = ">>> DATA_SYNC_IN_PROGRESS...";
            document.getElementById('chat-flow').appendChild(d);
            return d;
        }

        function switchChat(id) { currentId = id; renderList(); renderMsgs(); }
        function deleteChat(id) { chats = chats.filter(c => c.id !== id); currentId = chats[0]?.id; save(); renderList(); renderMsgs(); }
        function save() { localStorage.setItem('eclipse_v21', JSON.stringify(chats)); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        document.getElementById('user-input').onkeydown = (e) => { if(e.key === 'Enter') handleSend(); };
    </script>
</body>
</html>
