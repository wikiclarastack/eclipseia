<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eclipse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        * { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: #000; color: #fff; height: 100dvh; overflow: hidden; }

        /* Animações de Transição */
        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Glassmorphism Suave */
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* Inputs elegantes */
        input { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        input:focus { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.3); outline: none; }

        /* Scrollbar Invisível */
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .btn-primary { background: #fff; color: #000; transition: 0.3s; font-weight: 700; }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-primary:active { transform: scale(0.98); }

        #chat-flow div p { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="flex items-center justify-center overflow-hidden">

    <section id="auth-screen" class="w-full max-w-md p-6 md:p-10 fade-in z-50">
        <div id="login-container">
            <h1 class="text-5xl font-bold tracking-tighter mb-2">Eclipse</h1>
            <p class="text-gray-400 mb-8">Conecte-se para continuar.</p>
            <div class="space-y-4">
                <input id="login-email" type="email" placeholder="E-mail" class="w-full p-4 rounded-2xl">
                <input id="login-pass" type="password" placeholder="Senha" class="w-full p-4 rounded-2xl">
                <button onclick="handleLogin()" class="btn-primary w-full p-4 rounded-2xl">Entrar</button>
                <p class="text-center text-sm text-gray-500 mt-6">Ainda não tem acesso? <button onclick="toggleAuth(false)" class="text-white font-semibold">Criar conta</button></p>
            </div>
        </div>

        <div id="register-container" class="hidden">
            <h1 class="text-4xl font-bold tracking-tighter mb-2">Criar conta</h1>
            <p class="text-gray-400 mb-8">Junte-se ao sistema.</p>
            <div class="space-y-4">
                <input id="reg-name" type="text" placeholder="Como devemos te chamar?" class="w-full p-4 rounded-2xl">
                <input id="reg-email" type="email" placeholder="E-mail" class="w-full p-4 rounded-2xl">
                <input id="reg-pass" type="password" placeholder="Senha" class="w-full p-4 rounded-2xl">
                <button onclick="handleSignup()" class="btn-primary w-full p-4 rounded-2xl">Finalizar Registro</button>
                <p class="text-center text-sm text-gray-500 mt-6">Já possui conta? <button onclick="toggleAuth(true)" class="text-white font-semibold">Fazer Login</button></p>
            </div>
        </div>
    </section>

    <main id="app-main" class="hidden fixed inset-0 flex flex-col md:flex-row bg-[#080808] fade-in">
        
        <aside id="sidebar" class="w-full md:w-72 h-full glass border-none md:border-r border-white/5 flex flex-col z-40 transition-all duration-500 ease-in-out">
            <div class="p-6 flex items-center justify-between">
                <span class="text-2xl font-bold tracking-tighter">Eclipse</span>
                <button onclick="toggleSidebar(false)" class="md:hidden text-gray-400">✕</button>
            </div>

            <div class="flex-1 px-4 space-y-2 overflow-y-auto no-scrollbar" id="chat-history">
                </div>

            <div class="p-4 border-t border-white/5">
                <div onclick="openSettings()" class="flex items-center gap-3 p-3 rounded-2xl hover:bg-white/5 transition cursor-pointer">
                    <img id="user-avatar" src="https://api.dicebear.com/7.x/shapes/svg?seed=Eclipse" class="w-10 h-10 rounded-full border border-white/10 object-cover">
                    <div class="flex-1 overflow-hidden">
                        <p id="display-name" class="text-sm font-bold truncate">Usuário</p>
                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Configurações</p>
                    </div>
                </div>
            </div>
        </aside>

        <section class="flex-1 flex flex-col relative h-full">
            <header class="p-5 flex items-center md:hidden border-b border-white/5">
                <button onclick="toggleSidebar(true)" class="text-sm font-bold">Histórico</button>
            </header>

            <div id="chat-flow" class="flex-1 overflow-y-auto p-6 md:p-12 space-y-8 no-scrollbar">
                </div>

            <div class="p-6 md:pb-10 md:px-12">
                <div class="max-w-4xl mx-auto flex items-center gap-3 glass p-2 rounded-[2.5rem]">
                    <button onclick="newChat()" class="p-4 text-gray-400 hover:text-white transition desktop-only">＋</button>
                    <input id="user-input" type="text" placeholder="Como posso ajudar hoje?" class="flex-1 bg-transparent py-4 px-2 border-none text-sm">
                    <button onclick="handleSend()" class="btn-primary px-8 py-4 rounded-full text-xs uppercase">Enviar</button>
                </div>
            </div>
        </section>

        <section id="settings-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
            <div class="w-full max-w-sm glass rounded-[3rem] p-8 fade-in">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-bold">Perfil</h2>
                    <button onclick="closeSettings()" class="text-gray-500">Fechar</button>
                </div>
                
                <div class="space-y-6">
                    <div class="flex flex-col items-center">
                        <img id="preview-avatar" src="" class="w-20 h-20 rounded-full mb-4 border-2 border-white/10">
                        <input id="set-avatar-url" type="text" placeholder="URL da foto de perfil" class="w-full p-3 rounded-xl text-xs mb-3">
                        <input id="set-display-name" type="text" placeholder="Nome de exibição" class="w-full p-3 rounded-xl text-xs">
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="saveProfile()" class="btn-primary w-full py-4 rounded-2xl text-sm">Salvar Alterações</button>
                        <button onclick="logout()" class="w-full py-4 text-red-500 font-bold text-sm">Sair da conta</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAsP3iDayVoX9LivuqBWMXpMbsidn5Fd-0",
            authDomain: "fkaa-2e852.firebaseapp.com",
            projectId: "fkaa-2e852",
            storageBucket: "fkaa-2e852.firebasestorage.app",
            messagingSenderId: "258882319543",
            appId: "1:258882319543:web:d665c1adbc4a1479afc932"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // AUTH & UI FLOW
        function toggleAuth(isLogin) {
            document.getElementById('login-container').classList.toggle('hidden', !isLogin);
            document.getElementById('register-container').classList.toggle('hidden', isLogin);
        }

        async function handleSignup() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            try {
                const res = await auth.createUserWithEmailAndPassword(email, pass);
                await res.user.updateProfile({ displayName: name });
                location.reload();
            } catch(e) { alert(e.message); }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try { await auth.signInWithEmailAndPassword(email, pass); initApp(); } catch(e) { alert("Erro no login."); }
        }

        function logout() { auth.signOut(); location.reload(); }

        // PERFIL
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.remove('hidden');
            const user = auth.currentUser;
            document.getElementById('preview-avatar').src = user.photoURL || `https://api.dicebear.com/7.x/shapes/svg?seed=${user.uid}`;
            document.getElementById('set-display-name').value = user.displayName;
        }

        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

        async function saveProfile() {
            const user = auth.currentUser;
            const newName = document.getElementById('set-display-name').value;
            const newPhoto = document.getElementById('set-avatar-url').value;
            await user.updateProfile({ displayName: newName, photoURL: newPhoto || user.photoURL });
            location.reload();
        }

        // SIDEBAR MOBILE
        function toggleSidebar(open) {
            const side = document.getElementById('sidebar');
            side.style.transform = open ? 'translateX(0)' : 'translateX(-100%)';
            if (window.innerWidth > 768) side.style.transform = 'none';
        }

        // CHAT ENGINE
        let chats = JSON.parse(localStorage.getItem('eclipse_v22')) || [];
        let currentId = null;

        function initApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-main').classList.remove('hidden');
            const user = auth.currentUser;
            document.getElementById('display-name').innerText = user.displayName;
            document.getElementById('user-avatar').src = user.photoURL || `https://api.dicebear.com/7.x/shapes/svg?seed=${user.uid}`;
            renderList();
            if(chats.length > 0) switchChat(chats[0].id); else newChat();
        }

        function newChat() {
            const id = Date.now();
            const hour = new Date().getHours();
            const greet = hour < 12 ? "Bom dia" : hour < 18 ? "Boa tarde" : "Boa noite";
            chats.unshift({ id, title: "Nova conversa", messages: [{ role: 'model', parts: [{ text: `${greet}, ${auth.currentUser.displayName}. Como posso ajudar hoje?` }] }] });
            currentId = id; save(); renderList(); renderMsgs();
        }

        async function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;

            const chat = chats.find(c => c.id === currentId);
            if(chat.messages.length <= 1) chat.title = text.substring(0, 20);
            chat.messages.push({ role: 'user', parts: [{ text }] });
            input.value = ''; renderMsgs();

            const load = showLoader();
            try {
                const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messages: chat.messages}) });
                const data = await res.json();
                load.remove();
                chat.messages.push({ role: 'model', parts: [{ text: data.reply }] });
                save(); renderMsgs(); renderList();
            } catch(e) { load.innerText = "Erro ao processar."; }
        }

        function renderMsgs() {
            const flow = document.getElementById('chat-flow'); flow.innerHTML = '';
            const active = chats.find(c => c.id === currentId);
            active.messages.forEach(m => {
                const isB = m.role === 'model';
                const div = document.createElement('div');
                div.className = `flex ${isB ? 'justify-start' : 'justify-end'} fade-in`;
                div.innerHTML = `
                    <div class="max-w-[85%] md:max-w-[70%] ${isB ? 'bg-white/5 rounded-3xl p-6' : 'bg-white text-black rounded-3xl p-4 px-6'}">
                        <p class="text-[10px] font-bold uppercase opacity-40 mb-2">${isB ? 'Eclipse' : 'Você'}</p>
                        <div class="text-sm md:text-base leading-relaxed">${isB ? marked.parse(m.parts[0].text) : m.parts[0].text}</div>
                    </div>`;
                flow.appendChild(div);
            });
            flow.scrollTop = flow.scrollHeight;
        }

        function renderList() {
            const list = document.getElementById('chat-history'); list.innerHTML = '';
            chats.forEach(c => {
                const d = document.createElement('div');
                d.className = `p-4 rounded-2xl cursor-pointer text-sm transition ${c.id === currentId ? 'bg-white/10 text-white font-bold' : 'text-gray-500 hover:bg-white/5'}`;
                d.onclick = () => switchChat(c.id);
                d.innerHTML = `<div class="flex justify-between items-center"><span class="truncate pr-2">${c.title}</span><button onclick="event.stopPropagation(); delChat(${c.id})" class="opacity-30 hover:opacity-100">✕</button></div>`;
                list.appendChild(d);
            });
        }

        function showLoader() {
            const d = document.createElement('div'); d.className = 'text-center text-xs text-gray-500 animate-pulse py-4'; d.innerText = "Eclipse está processando...";
            document.getElementById('chat-flow').appendChild(d);
            return d;
        }

        function switchChat(id) { currentId = id; renderList(); renderMsgs(); if(window.innerWidth < 768) toggleSidebar(false); }
        function delChat(id) { chats = chats.filter(c => c.id !== id); currentId = chats[0]?.id; save(); renderList(); renderMsgs(); }
        function save() { localStorage.setItem('eclipse_v22', JSON.stringify(chats)); }
        document.getElementById('user-input').onkeydown = (e) => { if(e.key === 'Enter') handleSend(); };
        
        // Mantém logado
        auth.onAuthStateChanged(user => { if(user) initApp(); });
    </script>
</body>
</html>
